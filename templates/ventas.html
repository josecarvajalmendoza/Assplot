{% extends "layout.html" %}

{% block title %}Gestión de Ventas - As Plot Center{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Gestión de Ventas</h1>
    <p>Administra las ventas y facturas del sistema</p>
    <a href="{{ url_for('crear_venta') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i>
        Nueva Venta
    </a>
</div>

<div class="search-section">
    <form method="GET" class="search-form">
        <div class="search-input">
            <i class="fas fa-search"></i>
            <input type="text" name="search" placeholder="Buscar por cliente..." value="{{ search }}">
        </div>
        <select name="estado" class="filter-select">
            <option value="">Todos los Estados</option>
            <option value="completada" {% if estado == 'completada' %}selected{% endif %}>Completada</option>
            <option value="pendiente" {% if estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
            <option value="cancelada" {% if estado == 'cancelada' %}selected{% endif %}>Cancelada</option>
        </select>
        <button type="submit" class="btn btn-secondary">
            <i class="fas fa-filter"></i>
            Filtrar
        </button>
    </form>
</div>

<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>Factura #</th>
                <th>Cliente</th>
                <th>Fecha</th>
                <th>Método de Pago</th>
                <th>Total</th>
                <th>Estado</th>
                <th>Atendido por</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for venta in ventas %}
            <tr>
                <td><strong>#{{ "%06d"|format(venta.id_venta) }}</strong></td>
                <td>{{ venta.cliente.nombre_completo }}</td>
                <td>{{ venta.fecha_venta.strftime('%d/%m/%Y %H:%M') }}</td>
                <td>{{ venta.metodo_pago.title() if venta.metodo_pago else '-' }}</td>
                <td class="text-right"><strong>${{ "%.2f"|format(venta.total) }}</strong></td>
                <td>
                    <span class="status-badge status-{{ venta.estado }}">
                        {{ venta.estado.title() }}
                    </span>
                </td>
                <td>{{ venta.usuario.nombre_usuario }}</td>
                <td>
                    <div class="action-buttons">
                        <a href="{{ url_for('ver_venta', id=venta.id_venta) }}" 
                           class="btn btn-sm btn-info" title="Ver Detalle">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="{{ url_for('imprimir_venta', id=venta.id_venta) }}" 
                           class="btn btn-sm btn-primary" title="Imprimir">
                            <i class="fas fa-print"></i>
                        </a>
                        {% if venta.estado != 'cancelada' %}
                        <a href="{{ url_for('eliminar_venta', id=venta.id_venta) }}" 
                           class="btn btn-sm btn-red" title="Cancelar"
                           onclick="return confirm('¿Estás seguro de cancelar esta venta?')">
                            <i class="fas fa-ban"></i>
                        </a>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="8" class="text-center">
                    <div class="no-data">
                        <i class="fas fa-receipt"></i>
                        <p>No hay ventas registradas</p>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="summary-section">
    <div class="summary-card">
        <h3>Total de Ventas</h3>
        <p class="summary-value">{{ ventas|length }}</p>
    </div>
    <div class="summary-card">
        <h3>Ventas Completadas</h3>
        <p class="summary-value">{{ ventas|selectattr('estado', 'equalto', 'completada')|list|length }}</p>
    </div>
    <div class="summary-card">
        <h3>Ingresos Totales</h3>
        <p class="summary-value">${{ "%.2f"|format(ventas|selectattr('estado', 'equalto', 'completada')|sum(attribute='total')) }}</p>
    </div>
</div>
{% endblock %}